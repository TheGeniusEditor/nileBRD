<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BRD Portal • IT Workspace (ishaan.it@bank.com)</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --border2:#f1f5f9;
      --shadow: 0 10px 28px rgba(2,6,23,.08);
      --r:16px;

      --primary:#2563eb;   /* approve */
      --success:#16a34a;   /* accept */
      --warning:#f59e0b;   /* request updates */
      --danger:#ef4444;    /* reject */
      --indigo:#4f46e5;    /* export */
      --slate:#334155;     /* neutral */
      --pink:#db2777;      /* AI */
      --teal:#0d9488;      /* add */
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:var(--font); background:var(--bg); color:var(--text)}
    a{color:inherit; text-decoration:none}

    .topbar{position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid var(--border)}
    .topbar-inner{max-width:1480px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:36px; height:36px; border-radius:14px; background:linear-gradient(135deg,#f97316,#fb7185); box-shadow:0 10px 20px rgba(249,115,22,.18)}
    .brand h1{margin:0; font-size:15px; letter-spacing:-.2px}
    .brand .sub{margin:4px 0 0; font-size:12px; color:var(--muted)}
    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:13px}
    .dot{width:8px; height:8px; border-radius:999px; background:#16a34a}
    .kbd{font-family:var(--mono); font-size:12px; padding:2px 6px; border:1px solid var(--border); border-bottom-width:2px; border-radius:8px; color:var(--muted); background:#fff}

    .wrap{max-width:1480px; margin:0 auto; padding:16px}
    .layout{display:grid; grid-template-columns:390px 1fr; gap:14px; align-items:start}
    .card{border:1px solid var(--border); border-radius:var(--r); background:#fff; box-shadow:var(--shadow); overflow:hidden}
    .card.noshadow{box-shadow:none}
    .card-head{padding:14px 14px 10px; border-bottom:1px solid var(--border2); display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .card-head h3{margin:0; font-size:14px}
    .card-head p{margin:6px 0 0; font-size:12.5px; color:var(--muted); line-height:1.35}
    .card-body{padding:14px}
    .hr{height:1px; background:var(--border2); margin:12px 0}

    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:850;
      display:inline-flex; align-items:center; gap:8px;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow); border-color:#d1d5db}
    .btn:active{transform:translateY(0)}
    .btn.small{padding:7px 10px; border-radius:10px; font-size:13px}
    .btn.primary{background:linear-gradient(135deg,var(--primary),#60a5fa); color:#fff; border-color:transparent}
    .btn.success{background:linear-gradient(135deg,var(--success),#22c55e); color:#fff; border-color:transparent}
    .btn.warn{background:linear-gradient(135deg,var(--warning),#fbbf24); color:#111827; border-color:transparent}
    .btn.danger{background:linear-gradient(135deg,var(--danger),#fb7185); color:#fff; border-color:transparent}
    .btn.export{background:linear-gradient(135deg,var(--indigo),#7c3aed); color:#fff; border-color:transparent}
    .btn.ai{background:linear-gradient(135deg,var(--pink),#f472b6); color:#fff; border-color:transparent}
    .btn.add{background:linear-gradient(135deg,var(--teal),#22c55e); color:#fff; border-color:transparent}
    .btn.neutral{background:linear-gradient(135deg,var(--slate),#64748b); color:#fff; border-color:transparent}

    .nav{display:flex; flex-direction:column; gap:6px}
    .nav a{
      padding:10px 10px; border-radius:12px;
      border:1px solid transparent; color:var(--muted);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900;
    }
    .nav a.active{background:rgba(249,115,22,.10); border-color:rgba(249,115,22,.22); color:var(--text)}
    .nav a:hover{background:#f8fafc; border-color:var(--border); color:var(--text)}
    .badge{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:#fff}
    .mono{font-family:var(--mono)}

    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .span-12{grid-column:span 12}
    .span-8{grid-column:span 8}
    .span-6{grid-column:span 6}
    .span-4{grid-column:span 4}
    .title{font-size:20px; margin:0; letter-spacing:-.3px}
    .subtext{margin:6px 0 0; font-size:13px; color:var(--muted)}

    label{font-size:12px; color:var(--muted); font-weight:900}
    input[type="text"], input[type="number"], input[type="date"], textarea, select{
      width:100%;
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      background:#fff;
      color:var(--text);
      font-size:14px;
    }
    textarea{min-height:110px; resize:vertical}
    .inputs{display:grid; grid-template-columns:repeat(12,1fr); gap:10px}
    .field{grid-column:span 6; display:flex; flex-direction:column; gap:6px}
    .field.full{grid-column:span 12}
    .field.third{grid-column:span 4}
    .help{font-size:12.5px; color:var(--muted); line-height:1.35}
    .note{border:1px dashed #d1d5db; background:#f8fafc; border-radius:12px; padding:10px; color:var(--muted); font-size:12.5px; line-height:1.35; white-space:pre-wrap}

    .table{
      width:100%;
      border-collapse:collapse;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .table th,.table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border2);
      text-align:left;
      vertical-align:top;
      font-size:13px;
    }
    .table th{background:#f8fafc; color:var(--muted); font-weight:900}
    .table tr:last-child td{border-bottom:none}

    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px; font-weight:900; color:var(--muted)}
    .chip.red{border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.06); color:#b91c1c}
    .chip.amber{border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.07); color:#92400e}
    .chip.green{border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.07); color:#166534}

    /* Modal */
    .backdrop{
      position:fixed; inset:0; z-index:60;
      background: rgba(2,6,23,.45);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(1240px, 100%);
      max-height:92vh;
      overflow:auto;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 25px 70px rgba(2,6,23,.25);
    }
    .modal-head{
      padding:12px 14px;
      border-bottom:1px solid var(--border2);
      display:flex; align-items:center; justify-content:space-between; gap:10px
    }
    .modal-head h3{margin:0; font-size:14px}
    .modal-body{padding:14px}

    /* Toast */
    .toast-wrap{position:fixed; right:16px; bottom:16px; z-index:80; display:flex; flex-direction:column; gap:10px}
    .toast{
      width:min(460px, calc(100vw - 32px));
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:10px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .ticon{width:26px; height:26px; border-radius:10px; background:rgba(249,115,22,.12); display:flex; align-items:center; justify-content:center; flex:0 0 auto}
    .toast h4{margin:0; font-size:13px}
    .toast p{margin:4px 0 0; font-size:12.5px; color:var(--muted)}

    /* Page Switcher */
    .page-switcher{
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color:var(--text);
      font-size:13px;
      font-family:var(--font);
      cursor:pointer;
      font-weight:700;
    }
    .page-switcher:hover{border-color:#d1d5db; background:#f8fafc}

    @media (max-width:1240px){
      .layout{grid-template-columns:1fr}
      .span-8,.span-6,.span-4{grid-column:span 12}
      .field,.field.third{grid-column:span 12}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>IT Workspace • BRD Automation</h1>
          <div class="sub">Signed in as <span class="mono">ishaan.it@bank.com</span> • Role: IT</div>
        </div>
      </div>
      <select class="page-switcher" id="pageSwitcher">
        <option value="Admin.html">Admin</option>
        <option value="BA.html">BA Workspace</option>
        <option value="Compliance.html">Compliance</option>
        <option value="In Take 1.html">Intake Tracker</option>
        <option value="Infosec.html">InfoSec</option>
        <option value="IT.html" selected>IT</option>
        <option value="Risk.html">Risk</option>
        <option value="SME.html">SME</option>
        <option value="User Management 1.html">User Management</option>
      </select>
      <div class="right">
        <div class="pill"><span class="dot"></span><span id="activeBrdPill">No BRD selected</span></div>
        <div class="pill"><span class="mono">IT Review</span> <span class="kbd">ON</span></div>
        <button class="btn small neutral" id="resetBtn" title="Clears local data">Reset</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">
      <!-- LEFT -->
      <aside class="card">
        <div class="card-head">
          <div>
            <h3>IT Navigation</h3>
            <p>Architecture, integration, infra, SLAs, observability, capacity, DR/BCP, rollout and operational readiness.</p>
          </div>
        </div>
        <div class="card-body">
          <div class="nav" id="nav">
            <a href="#" data-view="inbox" class="active">IT Inbox <span class="badge" id="inboxBadge">0</span></a>
            <a href="#" data-view="architecture">Solution Architecture <span class="badge">HLD</span></a>
            <a href="#" data-view="integration">Integrations & APIs <span class="badge">Interfaces</span></a>
            <a href="#" data-view="infra">Infra & Environments <span class="badge">Dev/Test/Prod</span></a>
            <a href="#" data-view="nfr">NFRs & SLAs <span class="badge">Perf</span></a>
            <a href="#" data-view="ops">Ops Readiness <span class="badge">Runbooks</span></a>
            <a href="#" data-view="dr">DR / BCP <span class="badge">RTO/RPO</span></a>
            <a href="#" data-view="cutover">Release & Cutover <span class="badge">Plan</span></a>
            <a href="#" data-view="decision">IT Decision <span class="badge">Sign-off</span></a>
            <a href="#" data-view="audit">Audit Trail <span class="badge">Events</span></a>
          </div>

          <div class="hr"></div>

          <div class="note">
            <b>IT checklist:</b><br/>
            • HLD + components + environments defined?<br/>
            • API contracts, error handling, retries, idempotency?<br/>
            • Observability: logs/metrics/traces + dashboards + alerts?<br/>
            • Capacity, load model, rate limits, performance SLAs?<br/>
            • DR/BCP: RTO/RPO, failover steps, data backups?<br/>
            • Runbooks, on-call, rollback, release/cutover plan?
          </div>

          <div class="hr"></div>

          <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
            <button class="btn ai" id="aiItBtn">✨ AI IT Scan</button>
            <button class="btn export" id="exportItBtn">Export IT Pack</button>
          </div>
          <div class="help" style="margin-top:8px">Exports architecture + integration + NFR + DR + runbooks + decision log.</div>
        </div>
      </aside>

      <!-- RIGHT -->
      <main class="grid">
        <!-- INBOX -->
        <section class="card span-12" id="view-inbox">
          <div class="card-head">
            <div>
              <h3>IT Inbox</h3>
              <p>BRDs awaiting IT review.</p>
            </div>
            <div class="right">
              <div style="min-width:260px">
                <label>Search</label>
                <input id="searchInbox" type="text" placeholder="Search by ID/title/domain…" />
              </div>
              <div style="min-width:220px">
                <label>Filter</label>
                <select id="filterInbox">
                  <option value="ALL">All</option>
                  <option value="In Review">In Review</option>
                  <option value="Changes Requested">Changes Requested</option>
                  <option value="Approved">Approved</option>
                </select>
              </div>
            </div>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>BRD</th>
                  <th>Status</th>
                  <th>Updated</th>
                  <th>IT Readiness</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inboxTable"></tbody>
            </table>
          </div>
        </section>

        <!-- ARCHITECTURE -->
        <section class="card span-12" id="view-architecture" style="display:none">
          <div class="card-head">
            <div>
              <h3>Solution Architecture (HLD)</h3>
              <p>Components, data stores, trust boundaries, and deployment shape. Attach diagrams in evidence field.</p>
            </div>
            <div class="right">
              <span class="badge">Status: <b id="statusText">—</b></span>
              <button class="btn add" id="addCompBtn">+ Add Component</button>
              <button class="btn ai" id="aiArchBtn">✨ AI: Suggest HLD</button>
            </div>
          </div>
          <div class="card-body">
            <div class="grid">
              <div class="span-12">
                <h2 class="title" id="brdTitle">No BRD selected</h2>
                <div class="subtext" id="brdMeta">—</div>
              </div>
              <div class="span-12">
                <div class="help" id="scoreText">—</div>
              </div>
            </div>

            <div class="hr"></div>

            <table class="table">
              <thead>
                <tr>
                  <th>Component ID</th>
                  <th>Component</th>
                  <th>Purpose</th>
                  <th>Tech/Hosting</th>
                  <th>Data</th>
                  <th>Security</th>
                  <th>Owner</th>
                  <th>Evidence</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="compTable"></tbody>
            </table>

            <div class="note" style="margin-top:12px">
              Components could include: Web UI, API gateway, BRD service, Versioning store, Workflow engine, Search index, File store, Audit ledger, Notification service, Integrations adapters, Reporting.
            </div>
          </div>
        </section>

        <!-- INTEGRATION -->
        <section class="card span-12" id="view-integration" style="display:none">
          <div class="card-head">
            <div>
              <h3>Integrations & APIs</h3>
              <p>All inbound/outbound integrations. Capture auth, rate limits, retries, idempotency, error contracts.</p>
            </div>
            <div class="right">
              <button class="btn add" id="addApiBtn">+ Add Interface</button>
              <button class="btn ai" id="aiApiBtn">✨ AI: Suggest Interfaces</button>
            </div>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>API ID</th>
                  <th>Direction</th>
                  <th>System</th>
                  <th>Endpoint / Interface</th>
                  <th>Auth</th>
                  <th>Retry/Idempotency</th>
                  <th>SLA / Rate Limit</th>
                  <th>Data</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="apiTable"></tbody>
            </table>
          </div>
        </section>

        <!-- INFRA -->
        <section class="card span-12" id="view-infra" style="display:none">
          <div class="card-head">
            <div>
              <h3>Infra & Environments</h3>
              <p>Environments, network, firewall/WAF, secrets, CI/CD, and access.</p>
            </div>
            <div class="right">
              <button class="btn add" id="addEnvBtn">+ Add Item</button>
              <button class="btn ai" id="aiInfraBtn">✨ AI: Suggest Infra</button>
            </div>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>Item ID</th>
                  <th>Area</th>
                  <th>Requirement</th>
                  <th>Environment</th>
                  <th>Owner</th>
                  <th>Evidence</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="infraTable"></tbody>
            </table>
          </div>
        </section>

        <!-- NFR -->
        <section class="card span-12" id="view-nfr" style="display:none">
          <div class="card-head">
            <div>
              <h3>NFRs & SLAs</h3>
              <p>Performance, availability, scalability, observability and cost. Includes load model + SLOs.</p>
            </div>
            <div class="right">
              <button class="btn add" id="addNfrBtn">+ Add NFR</button>
              <button class="btn ai" id="aiNfrBtn">✨ AI: Suggest NFRs</button>
            </div>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>NFR ID</th>
                  <th>Category</th>
                  <th>Requirement</th>
                  <th>Metric/SLO</th>
                  <th>How measured</th>
                  <th>Owner</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="nfrTable"></tbody>
            </table>

            <div class="note" style="margin-top:12px">
              Include: p95 latency, throughput, concurrency, queue/backpressure, batch windows, availability %, error budget, alerting, and cost budgets.
            </div>
          </div>
        </section>

        <!-- OPS -->
        <section class="card span-12" id="view-ops" style="display:none">
          <div class="card-head">
            <div>
              <h3>Operational Readiness</h3>
              <p>Runbooks, monitoring, alerts, on-call, incident process, and access reviews.</p>
            </div>
            <div class="right">
              <button class="btn add" id="addOpsBtn">+ Add Runbook</button>
              <button class="btn ai" id="aiOpsBtn">✨ AI: Suggest Runbooks</button>
            </div>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>Runbook ID</th>
                  <th>Scenario</th>
                  <th>Detection</th>
                  <th>Steps</th>
                  <th>Owner</th>
                  <th>Evidence</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="opsTable"></tbody>
            </table>
          </div>
        </section>

        <!-- DR -->
        <section class="card span-12" id="view-dr" style="display:none">
          <div class="card-head">
            <div>
              <h3>DR / BCP</h3>
              <p>Disaster recovery and business continuity plan. Capture RTO/RPO and failover steps.</p>
            </div>
            <div class="right">
              <button class="btn add" id="addDrBtn">+ Add DR Item</button>
              <button class="btn ai" id="aiDrBtn">✨ AI: Suggest DR Plan</button>
            </div>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>DR ID</th>
                  <th>Scope</th>
                  <th>RTO</th>
                  <th>RPO</th>
                  <th>Failover / Recovery Steps</th>
                  <th>Owner</th>
                  <th>Evidence</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="drTable"></tbody>
            </table>
          </div>
        </section>

        <!-- CUTOVER -->
        <section class="card span-12" id="view-cutover" style="display:none">
          <div class="card-head">
            <div>
              <h3>Release & Cutover Plan</h3>
              <p>Deployment steps, data migration, rollback, comms, and CAB approvals.</p>
            </div>
            <div class="right">
              <button class="btn add" id="addCutBtn">+ Add Step</button>
              <button class="btn ai" id="aiCutBtn">✨ AI: Suggest Cutover</button>
            </div>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th>Step ID</th>
                  <th>Phase</th>
                  <th>Step</th>
                  <th>Owner</th>
                  <th>Rollback</th>
                  <th>Evidence</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="cutTable"></tbody>
            </table>
          </div>
        </section>

        <!-- DECISION -->
        <section class="card span-12" id="view-decision" style="display:none">
          <div class="card-head">
            <div>
              <h3>IT Decision (Sign-off)</h3>
              <p>Approve / Request Changes / Reject. Adds IT sign-off entry to approvals log.</p>
            </div>
            <div class="right">
              <button class="btn success" id="approveBtn">Approve (IT)</button>
              <button class="btn warn" id="changesBtn">Request Changes</button>
              <button class="btn danger" id="rejectBtn">Reject</button>
            </div>
          </div>
          <div class="card-body">
            <div class="inputs">
              <div class="field full">
                <label>Decision Notes (visible to BA + reviewers)</label>
                <textarea id="decisionNotes" placeholder="Summarize IT gaps, required infra/gates, and rollout concerns."></textarea>
              </div>
              <div class="field third">
                <label>IT readiness rating</label>
                <select id="rating">
                  <option value="Low">Low risk</option>
                  <option value="Medium" selected>Medium</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
              <div class="field third">
                <label>Changes due (days)</label>
                <input id="dueDays" type="number" min="1" value="7"/>
              </div>
              <div class="field third">
                <label>Evidence ref</label>
                <input id="evidenceRef" type="text" placeholder="Ticket / runbook / architecture doc ref"/>
              </div>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0; font-size:14px">Approvals log (read)</h3>
            <table class="table" style="margin-top:10px">
              <thead><tr><th>Stage</th><th>Decision</th><th>By</th><th>At</th><th>Notes</th></tr></thead>
              <tbody id="apTable"></tbody>
            </table>
          </div>
        </section>

        <!-- AUDIT -->
        <section class="card span-12" id="view-audit" style="display:none">
          <div class="card-head">
            <div>
              <h3>Audit Trail (read)</h3>
              <p>Append-only events (prototype stored in localStorage).</p>
            </div>
            <div class="right">
              <div style="min-width:280px">
                <label>Search</label>
                <input id="auditSearch" type="text" placeholder="Filter by action/user/id…"/>
              </div>
            </div>
          </div>
          <div class="card-body">
            <table class="table">
              <thead><tr><th>At</th><th>User</th><th>Action</th><th>Entity</th><th>ID</th><th>Meta</th></tr></thead>
              <tbody id="auditTable"></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- AI MODAL -->
  <div class="backdrop" id="aiModal">
    <div class="modal">
      <div class="modal-head">
        <h3>AI IT Scan (offline mock)</h3>
        <button class="btn small neutral" data-close>Close</button>
      </div>
      <div class="modal-body">
        <div class="grid" style="grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:10px">
          <button class="btn ai" id="aiArchRun">Suggest HLD</button>
          <button class="btn ai" id="aiNfrRun">Suggest NFRs</button>
          <button class="btn ai" id="aiOpsRun">Suggest Runbooks</button>
        </div>
        <div class="grid">
          <section class="card span-6 noshadow">
            <div class="card-head"><div><h3>Architecture</h3><p>Components.</p></div></div>
            <div class="card-body" id="aiArchOut"><div class="note">Run “Suggest HLD”.</div></div>
          </section>
          <section class="card span-6 noshadow">
            <div class="card-head"><div><h3>NFRs</h3><p>Performance/SLOs.</p></div></div>
            <div class="card-body" id="aiNfrOut"><div class="note">Run “Suggest NFRs”.</div></div>
          </section>
          <section class="card span-12 noshadow">
            <div class="card-head"><div><h3>Ops</h3><p>Runbooks.</p></div></div>
            <div class="card-body" id="aiOpsOut"><div class="note">Run “Suggest Runbooks”.</div></div>
          </section>
        </div>
        <div class="hr"></div>
        <div class="note"><b>Production:</b> connect to CMDB, monitoring tools, and ticketing for evidence references.</div>
      </div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <script>
    /***********************
     * IT Workspace (offline functional)
     * - reads shared BRDs from localStorage store
     * - maintains IT pack per BRD
     * - records IT decision to approvals log
     ***********************/
    const I_EMAIL = "ishaan.it@bank.com";
    const Store = { KEY:"brd_ba_workspace_v1", SELECTED:"brd_ba_selected_v1" };
    const Status = { DRAFT:"Draft", IN_REVIEW:"In Review", CHANGES:"Changes Requested", APPROVED:"Approved", PUBLISHED:"Published", ARCHIVED:"Archived" };

    const nowISO = () => new Date().toISOString();
    const fmt = (ts) => { try{ return new Date(ts).toLocaleString(undefined,{year:"numeric",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit"}); }catch{ return ts; } };
    const safeParse = (s, fb) => { try{return JSON.parse(s);}catch{return fb;} };
    const escapeHtml = (s) => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    const uid = (p="ID") => `${p}-${Math.random().toString(16).slice(2,10)}-${Math.random().toString(16).slice(2,10)}`.toUpperCase();

    const $ = (q) => document.querySelector(q);
    const $$ = (q) => Array.from(document.querySelectorAll(q));

    function toast(title, msg){
      const wrap = $("#toastWrap");
      const el = document.createElement("div");
      el.className="toast";
      el.innerHTML = `<div class="ticon">✓</div><div><h4>${escapeHtml(title)}</h4><p>${escapeHtml(msg)}</p></div>`;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, 2400);
      setTimeout(()=> el.remove(), 3000);
    }

    function readDB(){
      const raw = localStorage.getItem(Store.KEY);
      return raw ? safeParse(raw, { brds:[], audit:[] }) : { brds:[], audit:[] };
    }
    function writeDB(db){ localStorage.setItem(Store.KEY, JSON.stringify(db)); }
    function addAudit(action, entityId, meta={}){
      const db = readDB();
      db.audit.unshift({ at: nowISO(), by: I_EMAIL, action, entity:"BRD", id: entityId, meta });
      writeDB(db);
    }

    let db, selectedId;

    function getSelected(){
      if(!selectedId) selectedId = localStorage.getItem(Store.SELECTED) || db.brds[0]?.id;
      return db.brds.find(b=>b.id===selectedId) || db.brds[0];
    }
    function setSelected(id){
      selectedId = id;
      localStorage.setItem(Store.SELECTED, id);
      renderAll();
    }

    function setActiveNav(view){
      $$("#nav a").forEach(a=> a.classList.toggle("active", a.dataset.view===view));
      const map = {
        inbox:"#view-inbox",
        architecture:"#view-architecture",
        integration:"#view-integration",
        infra:"#view-infra",
        nfr:"#view-nfr",
        ops:"#view-ops",
        dr:"#view-dr",
        cutover:"#view-cutover",
        decision:"#view-decision",
        audit:"#view-audit"
      };
      Object.values(map).forEach(sel => $(sel).style.display="none");
      $(map[view]).style.display="block";
    }

    function openModal(id){ $(id).style.display="flex"; }
    function closeModal(id){ $(id).style.display="none"; }
    function wireModalClose(id){
      const back = $(id);
      back.addEventListener("click",(e)=>{ if(e.target===back) closeModal(id); });
      back.querySelectorAll("[data-close]").forEach(b=> b.addEventListener("click", ()=> closeModal(id)));
    }

    function ensurePack(brd){
      brd.reviews = brd.reviews || {};
      brd.reviews.it = brd.reviews.it || {
        updatedAt:null,
        components:[], // {id,name,purpose,tech,data,security,owner,evidence}
        apis:[],       // {id,dir,system,endpoint,auth,retry,sla,data}
        infra:[],      // {id,area,req,env,owner,evidence}
        nfrs:[],       // {id,cat,req,metric,measure,owner}
        ops:[],        // {id,scenario,detect,steps,owner,evidence}
        dr:[],         // {id,scope,rto,rpo,steps,owner,evidence}
        cutover:[]     // {id,phase,step,owner,rollback,evidence}
      };
      return brd.reviews.it;
    }

    function itScore(pack){
      const c = pack.components.length;
      const a = pack.apis.length;
      const i = pack.infra.length;
      const n = pack.nfrs.length;
      const o = pack.ops.length;
      const d = pack.dr.length;
      const cut = pack.cutover.length;
      let score = 0;
      score += Math.min(18, c*3);
      score += Math.min(18, a*3);
      score += Math.min(14, i*2);
      score += Math.min(16, n*2);
      score += Math.min(14, o*2);
      score += Math.min(10, d*2);
      score += Math.min(10, cut*2);
      return Math.max(0, Math.min(100, score));
    }
    function chip(score){
      if(score>=75) return {cls:"green", label:"Strong"};
      if(score>=45) return {cls:"amber", label:"Medium"};
      return {cls:"red", label:"Weak"};
    }

    function appendApproval(brd, decision, notes){
      brd.approvals = brd.approvals || [];
      brd.approvals.unshift({ stage:"IT Review", decision, by:I_EMAIL, at:nowISO(), notes });
      addAudit("IT_DECISION", brd.id, {decision});
    }

    function doDecision(kind){
      const brd = getSelected(); if(!brd) return;
      const rating = $("#rating").value;
      const due = parseInt($("#dueDays").value,10) || 7;
      const evRef = ($("#evidenceRef").value||"").trim();
      const notes = ($("#decisionNotes").value||"").trim();

      const pack = ensurePack(brd);
      pack.updatedAt = nowISO();

      const packNotes = [
        `IT rating: ${rating}`,
        kind==="Changes" ? `Changes due: ${due} days` : null,
        evRef ? `Evidence ref: ${evRef}` : null,
        notes ? `Notes: ${notes}` : "Notes: —"
      ].filter(Boolean).join(" | ");

      if(kind==="Approve"){
        appendApproval(brd, "Approved", packNotes);
        brd.status = Status.IN_REVIEW;
        toast("Approved","IT approval recorded (BRD remains In Review for remaining sign-offs).");
      } else if(kind==="Changes"){
        appendApproval(brd, "Changes Requested", packNotes);
        brd.status = Status.CHANGES;
        toast("Changes","Changes requested. BRD moved to Changes Requested.");
      } else if(kind==="Reject"){
        appendApproval(brd, "Rejected", packNotes);
        brd.status = Status.CHANGES;
        toast("Rejected","IT rejected. BRD moved to Changes Requested.");
      }

      brd.updatedAt = nowISO();
      writeDB(db);
      renderAll();
      setActiveNav("decision");
    }

    // CRUD (prompt-based)
    function addComponent(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      const name = prompt("Component name? (e.g., BRD Service, Workflow Engine)"); if(!name) return;
      const purpose = prompt("Purpose?") || "";
      const tech = prompt("Tech/Hosting?") || "On-prem/K8s/Cloud";
      const data = prompt("Data stores/flows?") || "";
      const security = prompt("Security notes (RBAC, network) ?") || "";
      const owner = prompt("Owner?") || "IT";
      const evidence = prompt("Evidence (diagram/ticket) ?") || "";
      pack.components.unshift({id:uid("CMP"), name, purpose, tech, data, security, owner, evidence, at:nowISO()});
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_ADD_COMPONENT", brd.id, {});
      toast("Added","Component added.");
      renderAll();
    }
    function delComponent(id){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      pack.components = pack.components.filter(x=>x.id!==id);
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_DEL_COMPONENT", brd.id, {id});
      toast("Deleted","Component removed.");
      renderAll();
    }

    function addApi(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      const dir = prompt("Direction (Inbound/Outbound)?") || "Outbound";
      const system = prompt("System name? (e.g., Core Banking, DMS, SIEM)"); if(!system) return;
      const endpoint = prompt("Endpoint / Interface? (e.g., POST /kyc/verify)"); if(!endpoint) return;
      const auth = prompt("Auth (mTLS/OAuth/API Key/VPN) ?") || "mTLS + OAuth";
      const retry = prompt("Retry/Idempotency?") || "Retries with backoff; idempotency key";
      const sla = prompt("SLA/Rate limit?") || "p95<500ms; 100 rps";
      const data = prompt("Data exchanged?") || "Minimal fields";
      pack.apis.unshift({id:uid("API"), dir, system, endpoint, auth, retry, sla, data, at:nowISO()});
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_ADD_API", brd.id, {});
      toast("Added","Interface added.");
      renderAll();
    }
    function delApi(id){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      pack.apis = pack.apis.filter(x=>x.id!==id);
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_DEL_API", brd.id, {id});
      toast("Deleted","Interface removed.");
      renderAll();
    }

    function addInfra(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      const area = prompt("Area (Network/WAF/Secrets/CI-CD/Access/DB) ?") || "Network";
      const req = prompt("Requirement?"); if(!req) return;
      const env = prompt("Environment (Dev/Test/UAT/Prod) ?") || "All";
      const owner = prompt("Owner?") || "IT";
      const evidence = prompt("Evidence (ticket/config ref) ?") || "";
      pack.infra.unshift({id:uid("INF"), area, req, env, owner, evidence, at:nowISO()});
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_ADD_INFRA", brd.id, {});
      toast("Added","Infra item added.");
      renderAll();
    }
    function delInfra(id){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      pack.infra = pack.infra.filter(x=>x.id!==id);
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_DEL_INFRA", brd.id, {id});
      toast("Deleted","Infra item removed.");
      renderAll();
    }

    function addNfr(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      const cat = prompt("Category (Performance/Availability/Scalability/Observability/Cost) ?") || "Performance";
      const req = prompt("Requirement?"); if(!req) return;
      const metric = prompt("Metric/SLO? (e.g., p95<800ms, 99.9% uptime)") || "";
      const measure = prompt("How measured (APM, logs, load test) ?") || "APM + load tests";
      const owner = prompt("Owner?") || "IT";
      pack.nfrs.unshift({id:uid("NFR"), cat, req, metric, measure, owner, at:nowISO()});
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_ADD_NFR", brd.id, {});
      toast("Added","NFR added.");
      renderAll();
    }
    function delNfr(id){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      pack.nfrs = pack.nfrs.filter(x=>x.id!==id);
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_DEL_NFR", brd.id, {id});
      toast("Deleted","NFR removed.");
      renderAll();
    }

    function addOps(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      const scenario = prompt("Scenario (e.g., API latency spike, queue backlog) ?"); if(!scenario) return;
      const detect = prompt("Detection (alert/dashboard) ?") || "Alert + dashboard";
      const steps = prompt("Steps (short) ?") || "Triage → mitigate → communicate → postmortem";
      const owner = prompt("Owner?") || "On-call";
      const evidence = prompt("Evidence (runbook link) ?") || "";
      pack.ops.unshift({id:uid("OPS"), scenario, detect, steps, owner, evidence, at:nowISO()});
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_ADD_OPS", brd.id, {});
      toast("Added","Runbook added.");
      renderAll();
    }
    function delOps(id){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      pack.ops = pack.ops.filter(x=>x.id!==id);
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_DEL_OPS", brd.id, {id});
      toast("Deleted","Runbook removed.");
      renderAll();
    }

    function addDr(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      const scope = prompt("Scope (App/DB/Queue/Integration) ?") || "App+DB";
      const rto = prompt("RTO (e.g., 2h) ?") || "4h";
      const rpo = prompt("RPO (e.g., 15m) ?") || "1h";
      const steps = prompt("Failover/Recovery steps (short) ?") || "Failover to DR → validate → switch DNS → monitor";
      const owner = prompt("Owner?") || "IT";
      const evidence = prompt("Evidence (DR test report) ?") || "";
      pack.dr.unshift({id:uid("DR"), scope, rto, rpo, steps, owner, evidence, at:nowISO()});
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_ADD_DR", brd.id, {});
      toast("Added","DR item added.");
      renderAll();
    }
    function delDr(id){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      pack.dr = pack.dr.filter(x=>x.id!==id);
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_DEL_DR", brd.id, {id});
      toast("Deleted","DR item removed.");
      renderAll();
    }

    function addCutover(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      const phase = prompt("Phase (Pre-go-live/Go-live/Post-go-live) ?") || "Go-live";
      const step = prompt("Step?"); if(!step) return;
      const owner = prompt("Owner?") || "IT";
      const rollback = prompt("Rollback? (short) ?") || "Rollback deployment; restore previous version";
      const evidence = prompt("Evidence (CAB ticket/runbook) ?") || "";
      pack.cutover.unshift({id:uid("CUT"), phase, step, owner, rollback, evidence, at:nowISO()});
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_ADD_CUTOVER", brd.id, {});
      toast("Added","Cutover step added.");
      renderAll();
    }
    function delCutover(id){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      pack.cutover = pack.cutover.filter(x=>x.id!==id);
      pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
      writeDB(db); addAudit("IT_DEL_CUTOVER", brd.id, {id});
      toast("Deleted","Cutover step removed.");
      renderAll();
    }

    // AI (mock)
    function aiArch(){
      return [
        {name:"BRD Web UI", purpose:"Create/edit/review BRDs with role-based controls", tech:"Web app + CDN", data:"Reads/writes BRD via API", security:"SSO + MFA + RBAC", owner:"IT/App", evidence:"UI flow doc"},
        {name:"BRD Service API", purpose:"BRD CRUD, versioning, approvals orchestration", tech:"Microservice", data:"Relational DB + audit ledger", security:"mTLS + JWT + RBAC", owner:"IT", evidence:"HLD"},
        {name:"Workflow Engine", purpose:"Maker-checker, approvals, stage gates", tech:"BPMN engine / workflow svc", data:"State machine + events", security:"SoD enforcement", owner:"IT", evidence:"Workflow spec"},
        {name:"Document Store", purpose:"Store generated BRD exports (PDF/DOCX)", tech:"Object storage", data:"Artifacts", security:"Encryption + signed URLs", owner:"IT", evidence:"Storage config"},
        {name:"Audit Ledger", purpose:"Append-only audit events for traceability", tech:"Log store/WORM", data:"Events", security:"Immutable retention", owner:"SecOps", evidence:"SIEM/WORM design"},
        {name:"Notification Service", purpose:"Email/Teams notifications on approvals/changes", tech:"Email/SMS/Teams", data:"Templates", security:"No PII in messages", owner:"IT", evidence:"Notification policy"}
      ];
    }
    function aiNfrs(){
      return [
        {cat:"Availability", req:"Service availability in production", metric:"99.9% monthly", measure:"SLO + error budget", owner:"IT"},
        {cat:"Performance", req:"BRD list/search response time", metric:"p95 < 800ms", measure:"APM + load tests", owner:"IT"},
        {cat:"Performance", req:"Approval action latency", metric:"p95 < 1s", measure:"APM", owner:"IT"},
        {cat:"Scalability", req:"Concurrent reviewers supported", metric:"500 concurrent users", measure:"Load tests", owner:"IT"},
        {cat:"Observability", req:"Dashboards + alerts for key services", metric:"Alerts for p95, error rate, queue lag", measure:"Monitoring", owner:"SecOps/IT"},
        {cat:"Cost", req:"Cloud spend guardrails", metric:"Budget alerts + autoscaling", measure:"FinOps dashboards", owner:"IT"}
      ];
    }
    function aiRunbooks(){
      return [
        {scenario:"API error rate spike", detect:"Alert: 5xx > threshold", steps:"Check deploys → rollback → check DB/connectivity → post update", owner:"On-call", evidence:"Runbook link"},
        {scenario:"Queue backlog", detect:"Alert: queue depth high", steps:"Scale consumers → inspect poison messages → throttle producers", owner:"On-call", evidence:"Runbook link"},
        {scenario:"DB latency high", detect:"APM DB time", steps:"Check locks → slow queries → scale/read replicas → incident comms", owner:"DBA/On-call", evidence:"DB runbook"},
        {scenario:"Integration failure (DMS/SIEM)", detect:"Alert: integration errors", steps:"Retry with backoff → circuit breaker → raise ticket to vendor", owner:"IT", evidence:"Vendor contact list"}
      ];
    }

    function aiScan(){
      const brd = getSelected(); if(!brd){ toast("Select BRD","Open a BRD first."); return; }
      openModal("#aiModal");

      $("#aiArchRun").onclick = ()=>{
        const pack = ensurePack(brd);
        const sug = aiArch();
        sug.forEach(x=> pack.components.unshift({id:uid("CMP"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_ARCH", brd.id, {count:sug.length});
        $("#aiArchOut").innerHTML = `<div class="note"><ul>${sug.map(x=>`<li><b>${escapeHtml(x.name)}:</b> ${escapeHtml(x.purpose)}</li>`).join("")}</ul></div>`;
        toast("AI","HLD components added.");
        renderAll();
      };

      $("#aiNfrRun").onclick = ()=>{
        const pack = ensurePack(brd);
        const sug = aiNfrs();
        sug.forEach(x=> pack.nfrs.unshift({id:uid("NFR"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_NFR", brd.id, {count:sug.length});
        $("#aiNfrOut").innerHTML = `<div class="note"><ul>${sug.map(x=>`<li><b>${escapeHtml(x.cat)}:</b> ${escapeHtml(x.metric)} • ${escapeHtml(x.req)}</li>`).join("")}</ul></div>`;
        toast("AI","NFRs added.");
        renderAll();
      };

      $("#aiOpsRun").onclick = ()=>{
        const pack = ensurePack(brd);
        const sug = aiRunbooks();
        sug.forEach(x=> pack.ops.unshift({id:uid("OPS"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_OPS", brd.id, {count:sug.length});
        $("#aiOpsOut").innerHTML = `<div class="note"><ul>${sug.map(x=>`<li><b>${escapeHtml(x.scenario)}:</b> ${escapeHtml(x.detect)}</li>`).join("")}</ul></div>`;
        toast("AI","Runbooks added.");
        renderAll();
      };
    }

    // Rendering
    function renderInbox(){
      const q = ($("#searchInbox").value||"").trim().toLowerCase();
      const f = $("#filterInbox").value || "ALL";
      let items = db.brds || [];
      items = items.filter(b => b.status !== Status.ARCHIVED);

      if(f!=="ALL") items = items.filter(b => b.status === f);

      if(q){
        items = items.filter(b =>
          (b.id||"").toLowerCase().includes(q) ||
          (b.master?.title||"").toLowerCase().includes(q) ||
          (b.master?.domain||"").toLowerCase().includes(q) ||
          (b.master?.product||"").toLowerCase().includes(q)
        );
      }

      $("#inboxBadge").textContent = String(items.filter(b=>b.status===Status.IN_REVIEW).length);

      $("#inboxTable").innerHTML = items.map(b=>{
        const pack = ensurePack(b);
        const sc = itScore(pack);
        const c = chip(sc);
        return `
          <tr>
            <td class="mono">${b.id}</td>
            <td>
              <div style="display:flex; flex-direction:column; gap:4px">
                <a href="#" data-open="${b.id}" style="font-weight:900">${escapeHtml(b.master?.title||"(untitled)")}</a>
                <div class="help">${escapeHtml(b.master?.domain||"—")} • ${escapeHtml(b.master?.product||"—")}</div>
              </div>
            </td>
            <td>${escapeHtml(b.status)}</td>
            <td>${fmt(b.updatedAt)}</td>
            <td><span class="chip ${c.cls}">${c.label} • ${sc}/100</span></td>
            <td style="white-space:nowrap">
              <button class="btn small primary" data-open="${b.id}">Open</button>
              <button class="btn small" data-go="decision" data-open="${b.id}">Decide</button>
            </td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="6" class="mono">No BRDs found.</td></tr>`;

      $("#inboxTable").querySelectorAll("[data-open]").forEach(el=>{
        el.addEventListener("click",(e)=>{
          e.preventDefault();
          const id = el.dataset.open;
          const go = el.dataset.go || "architecture";
          setSelected(id);
          setActiveNav(go);
          renderAll();
        });
      });
    }

    function renderHeader(){
      const brd = getSelected();
      if(!brd){
        $("#activeBrdPill").textContent = "No BRD selected";
        $("#brdTitle").textContent = "No BRD selected";
        $("#brdMeta").textContent = "Open a BRD from Inbox.";
        $("#statusText").textContent = "—";
        $("#scoreText").textContent = "—";
        return;
      }
      const pack = ensurePack(brd);
      const sc = itScore(pack);
      const c = chip(sc);

      $("#activeBrdPill").textContent = `${brd.master?.title || brd.id} • ${brd.status}`;
      $("#brdTitle").textContent = brd.master?.title || "(untitled)";
      $("#brdMeta").innerHTML = `<span class="mono">${brd.id}</span> • Owner: <span class="mono">${brd.ownerEmail||"—"}</span> • Updated: ${fmt(brd.updatedAt)}`;
      $("#statusText").textContent = brd.status;

      $("#scoreText").innerHTML = `IT readiness: <b>${sc}/100</b> • ${c.label} • Components: ${pack.components.length} • APIs: ${pack.apis.length} • Infra: ${pack.infra.length} • NFRs: ${pack.nfrs.length} • DR: ${pack.dr.length} • Updated: ${pack.updatedAt ? fmt(pack.updatedAt) : "—"}`;
    }

    function renderComponents(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      $("#compTable").innerHTML = pack.components.map(x=>`
        <tr>
          <td class="mono">${x.id}</td>
          <td><b>${escapeHtml(x.name||"—")}</b></td>
          <td>${escapeHtml(x.purpose||"—")}</td>
          <td>${escapeHtml(x.tech||"—")}</td>
          <td>${escapeHtml(x.data||"—")}</td>
          <td>${escapeHtml(x.security||"—")}</td>
          <td>${escapeHtml(x.owner||"—")}</td>
          <td class="mono">${escapeHtml(x.evidence||"—")}</td>
          <td style="white-space:nowrap"><button class="btn small danger" data-del="${x.id}">Delete</button></td>
        </tr>
      `).join("") || `<tr><td colspan="9" class="mono">No components yet. Add or use AI scan.</td></tr>`;
      $("#compTable").querySelectorAll("[data-del]").forEach(b=> b.addEventListener("click",()=>delComponent(b.dataset.del)));
    }

    function renderApis(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      $("#apiTable").innerHTML = pack.apis.map(x=>`
        <tr>
          <td class="mono">${x.id}</td>
          <td>${escapeHtml(x.dir||"—")}</td>
          <td><b>${escapeHtml(x.system||"—")}</b></td>
          <td class="mono">${escapeHtml(x.endpoint||"—")}</td>
          <td>${escapeHtml(x.auth||"—")}</td>
          <td>${escapeHtml(x.retry||"—")}</td>
          <td>${escapeHtml(x.sla||"—")}</td>
          <td>${escapeHtml(x.data||"—")}</td>
          <td style="white-space:nowrap"><button class="btn small danger" data-del="${x.id}">Delete</button></td>
        </tr>
      `).join("") || `<tr><td colspan="9" class="mono">No integrations yet.</td></tr>`;
      $("#apiTable").querySelectorAll("[data-del]").forEach(b=> b.addEventListener("click",()=>delApi(b.dataset.del)));
    }

    function renderInfra(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      $("#infraTable").innerHTML = pack.infra.map(x=>`
        <tr>
          <td class="mono">${x.id}</td>
          <td>${escapeHtml(x.area||"—")}</td>
          <td><b>${escapeHtml(x.req||"—")}</b></td>
          <td>${escapeHtml(x.env||"—")}</td>
          <td>${escapeHtml(x.owner||"—")}</td>
          <td class="mono">${escapeHtml(x.evidence||"—")}</td>
          <td style="white-space:nowrap"><button class="btn small danger" data-del="${x.id}">Delete</button></td>
        </tr>
      `).join("") || `<tr><td colspan="7" class="mono">No infra items yet.</td></tr>`;
      $("#infraTable").querySelectorAll("[data-del]").forEach(b=> b.addEventListener("click",()=>delInfra(b.dataset.del)));
    }

    function renderNfr(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      $("#nfrTable").innerHTML = pack.nfrs.map(x=>`
        <tr>
          <td class="mono">${x.id}</td>
          <td>${escapeHtml(x.cat||"—")}</td>
          <td><b>${escapeHtml(x.req||"—")}</b></td>
          <td>${escapeHtml(x.metric||"—")}</td>
          <td>${escapeHtml(x.measure||"—")}</td>
          <td>${escapeHtml(x.owner||"—")}</td>
          <td style="white-space:nowrap"><button class="btn small danger" data-del="${x.id}">Delete</button></td>
        </tr>
      `).join("") || `<tr><td colspan="7" class="mono">No NFRs yet.</td></tr>`;
      $("#nfrTable").querySelectorAll("[data-del]").forEach(b=> b.addEventListener("click",()=>delNfr(b.dataset.del)));
    }

    function renderOps(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      $("#opsTable").innerHTML = pack.ops.map(x=>`
        <tr>
          <td class="mono">${x.id}</td>
          <td><b>${escapeHtml(x.scenario||"—")}</b></td>
          <td>${escapeHtml(x.detect||"—")}</td>
          <td>${escapeHtml(x.steps||"—")}</td>
          <td>${escapeHtml(x.owner||"—")}</td>
          <td class="mono">${escapeHtml(x.evidence||"—")}</td>
          <td style="white-space:nowrap"><button class="btn small danger" data-del="${x.id}">Delete</button></td>
        </tr>
      `).join("") || `<tr><td colspan="7" class="mono">No runbooks yet.</td></tr>`;
      $("#opsTable").querySelectorAll("[data-del]").forEach(b=> b.addEventListener("click",()=>delOps(b.dataset.del)));
    }

    function renderDr(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      $("#drTable").innerHTML = pack.dr.map(x=>`
        <tr>
          <td class="mono">${x.id}</td>
          <td><b>${escapeHtml(x.scope||"—")}</b></td>
          <td>${escapeHtml(x.rto||"—")}</td>
          <td>${escapeHtml(x.rpo||"—")}</td>
          <td>${escapeHtml(x.steps||"—")}</td>
          <td>${escapeHtml(x.owner||"—")}</td>
          <td class="mono">${escapeHtml(x.evidence||"—")}</td>
          <td style="white-space:nowrap"><button class="btn small danger" data-del="${x.id}">Delete</button></td>
        </tr>
      `).join("") || `<tr><td colspan="8" class="mono">No DR plan yet.</td></tr>`;
      $("#drTable").querySelectorAll("[data-del]").forEach(b=> b.addEventListener("click",()=>delDr(b.dataset.del)));
    }

    function renderCutover(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      $("#cutTable").innerHTML = pack.cutover.map(x=>`
        <tr>
          <td class="mono">${x.id}</td>
          <td>${escapeHtml(x.phase||"—")}</td>
          <td><b>${escapeHtml(x.step||"—")}</b></td>
          <td>${escapeHtml(x.owner||"—")}</td>
          <td>${escapeHtml(x.rollback||"—")}</td>
          <td class="mono">${escapeHtml(x.evidence||"—")}</td>
          <td style="white-space:nowrap"><button class="btn small danger" data-del="${x.id}">Delete</button></td>
        </tr>
      `).join("") || `<tr><td colspan="7" class="mono">No cutover steps yet.</td></tr>`;
      $("#cutTable").querySelectorAll("[data-del]").forEach(b=> b.addEventListener("click",()=>delCutover(b.dataset.del)));
    }

    function renderApprovals(){
      const brd = getSelected(); if(!brd) return;
      $("#apTable").innerHTML = (brd.approvals||[]).map(a=>`
        <tr>
          <td>${escapeHtml(a.stage)}</td>
          <td>${escapeHtml(a.decision)}</td>
          <td class="mono">${escapeHtml(a.by)}</td>
          <td>${fmt(a.at)}</td>
          <td>${escapeHtml(a.notes||"—")}</td>
        </tr>
      `).join("") || `<tr><td colspan="5" class="mono">No approvals yet.</td></tr>`;
    }

    function renderAudit(){
      const q = ($("#auditSearch").value||"").trim().toLowerCase();
      let items = [...(db.audit||[])];
      if(q){
        items = items.filter(a =>
          (a.action||"").toLowerCase().includes(q) ||
          (a.by||"").toLowerCase().includes(q) ||
          (a.id||"").toLowerCase().includes(q) ||
          JSON.stringify(a.meta||{}).toLowerCase().includes(q)
        );
      }
      $("#auditTable").innerHTML = items.slice(0,450).map(a=>`
        <tr>
          <td>${fmt(a.at)}</td>
          <td class="mono">${escapeHtml(a.by)}</td>
          <td>${escapeHtml(a.action)}</td>
          <td>${escapeHtml(a.entity)}</td>
          <td class="mono">${escapeHtml(a.id)}</td>
          <td class="mono">${escapeHtml(JSON.stringify(a.meta||{}))}</td>
        </tr>
      `).join("") || `<tr><td colspan="6" class="mono">No audit entries.</td></tr>`;
    }

    function exportItPack(){
      const brd = getSelected(); if(!brd) return;
      const pack = ensurePack(brd);
      const payload = {
        brdId: brd.id,
        brdTitle: brd.master?.title || "",
        itEmail: I_EMAIL,
        exportedAt: nowISO(),
        itPack: pack,
        approvals: brd.approvals || []
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${brd.id}_IT_PACK.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      addAudit("EXPORT_IT_PACK", brd.id, {});
      toast("Exported","IT pack downloaded.");
    }

    function renderAll(){
      db = readDB();
      renderInbox();
      renderHeader();
      renderComponents();
      renderApis();
      renderInfra();
      renderNfr();
      renderOps();
      renderDr();
      renderCutover();
      renderApprovals();
      renderAudit();

      const brd = getSelected();
      if(brd) $("#activeBrdPill").textContent = `${brd.master?.title || brd.id} • ${brd.status}`;
      else $("#activeBrdPill").textContent = "No BRD selected";
    }

    function wire(){
      db = readDB();
      selectedId = localStorage.getItem(Store.SELECTED) || db.brds[0]?.id;

      $$("#nav a").forEach(a=>{
        a.addEventListener("click",(e)=>{
          e.preventDefault();
          setActiveNav(a.dataset.view);
          renderAll();
        });
      });

      $("#searchInbox").addEventListener("input", renderInbox);
      $("#filterInbox").addEventListener("change", renderInbox);

      $("#addCompBtn").addEventListener("click", addComponent);
      $("#aiArchBtn").addEventListener("click", ()=>{
        const brd = getSelected(); if(!brd) return;
        const pack = ensurePack(brd);
        const sug = aiArch();
        sug.forEach(x=> pack.components.unshift({id:uid("CMP"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_ARCH", brd.id, {count:sug.length});
        toast("AI","HLD components added.");
        renderAll();
      });

      $("#addApiBtn").addEventListener("click", addApi);
      $("#aiApiBtn").addEventListener("click", ()=>{
        const brd = getSelected(); if(!brd) return;
        const pack = ensurePack(brd);
        const sug = [
          {dir:"Outbound", system:"SSO/IDP", endpoint:"OIDC/SAML login + token introspection", auth:"mTLS + OIDC", retry:"N/A", sla:"99.9% | 50 rps", data:"Identity tokens"},
          {dir:"Outbound", system:"Email/Teams", endpoint:"POST /notify", auth:"API key in vault", retry:"Retry x3 + DLQ", sla:"p95<1s | 200 rps", data:"No PII in messages"},
          {dir:"Outbound", system:"DMS/Object Store", endpoint:"PUT/GET artifacts", auth:"Signed URLs + mTLS", retry:"Retry + checksum", sla:"p95<1s", data:"BRD exports"},
          {dir:"Outbound", system:"SIEM/Log store", endpoint:"Ship audit events", auth:"mTLS", retry:"Buffered shipping", sla:"Near real-time", data:"Audit events"}
        ];
        sug.forEach(x=> pack.apis.unshift({id:uid("API"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_API", brd.id, {count:sug.length});
        toast("AI","Interfaces added.");
        renderAll();
        setActiveNav("integration");
      });

      $("#addEnvBtn").addEventListener("click", addInfra);
      $("#aiInfraBtn").addEventListener("click", ()=>{
        const brd = getSelected(); if(!brd) return;
        const pack = ensurePack(brd);
        const sug = [
          {area:"Network", req:"Private subnets + firewall rules for app/db/log store", env:"Prod", owner:"IT", evidence:"Network diagram"},
          {area:"WAF", req:"WAF + rate limiting for public endpoints", env:"Prod", owner:"IT", evidence:"WAF policy"},
          {area:"Secrets", req:"All secrets in vault; rotation policy", env:"All", owner:"DevSecOps", evidence:"Vault config"},
          {area:"CI/CD", req:"Pipeline with approvals for prod; artifact signing", env:"All", owner:"IT", evidence:"Pipeline config"},
          {area:"Access", req:"Privileged access via PAM; periodic review", env:"Prod", owner:"InfoSec/IT", evidence:"PAM report"}
        ];
        sug.forEach(x=> pack.infra.unshift({id:uid("INF"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_INFRA", brd.id, {count:sug.length});
        toast("AI","Infra items added.");
        renderAll();
        setActiveNav("infra");
      });

      $("#addNfrBtn").addEventListener("click", addNfr);
      $("#aiNfrBtn").addEventListener("click", ()=>{
        const brd = getSelected(); if(!brd) return;
        const pack = ensurePack(brd);
        const sug = aiNfrs();
        sug.forEach(x=> pack.nfrs.unshift({id:uid("NFR"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_NFR", brd.id, {count:sug.length});
        toast("AI","NFRs added.");
        renderAll();
        setActiveNav("nfr");
      });

      $("#addOpsBtn").addEventListener("click", addOps);
      $("#aiOpsBtn").addEventListener("click", ()=>{
        const brd = getSelected(); if(!brd) return;
        const pack = ensurePack(brd);
        const sug = aiRunbooks();
        sug.forEach(x=> pack.ops.unshift({id:uid("OPS"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_OPS", brd.id, {count:sug.length});
        toast("AI","Runbooks added.");
        renderAll();
        setActiveNav("ops");
      });

      $("#addDrBtn").addEventListener("click", addDr);
      $("#aiDrBtn").addEventListener("click", ()=>{
        const brd = getSelected(); if(!brd) return;
        const pack = ensurePack(brd);
        const sug = [
          {scope:"BRD Service + DB", rto:"4h", rpo:"1h", steps:"Restore DB from latest backup → deploy service → verify → switch traffic", owner:"IT/DBA", evidence:"DR test report"},
          {scope:"Audit log store", rto:"2h", rpo:"15m", steps:"Failover to secondary log store → rehydrate dashboards", owner:"SecOps", evidence:"SIEM DR plan"}
        ];
        sug.forEach(x=> pack.dr.unshift({id:uid("DR"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_DR", brd.id, {count:sug.length});
        toast("AI","DR plan items added.");
        renderAll();
        setActiveNav("dr");
      });

      $("#addCutBtn").addEventListener("click", addCutover);
      $("#aiCutBtn").addEventListener("click", ()=>{
        const brd = getSelected(); if(!brd) return;
        const pack = ensurePack(brd);
        const sug = [
          {phase:"Pre-go-live", step:"UAT sign-off + security sign-off + CAB approval", owner:"IT/InfoSec", rollback:"Delay go-live", evidence:"CAB ticket"},
          {phase:"Go-live", step:"Deploy release to prod + run smoke tests", owner:"IT", rollback:"Rollback deployment", evidence:"Runbook"},
          {phase:"Go-live", step:"Enable feature flags gradually (10%→50%→100%)", owner:"IT", rollback:"Disable feature flag", evidence:"Feature flag config"},
          {phase:"Post-go-live", step:"24h hypercare monitoring + incident readiness", owner:"On-call", rollback:"Rollback if error budget exceeded", evidence:"Dashboard links"}
        ];
        sug.forEach(x=> pack.cutover.unshift({id:uid("CUT"), ...x, at:nowISO()}));
        pack.updatedAt = nowISO(); brd.updatedAt = nowISO();
        writeDB(db); addAudit("AI_IT_ADD_CUTOVER", brd.id, {count:sug.length});
        toast("AI","Cutover steps added.");
        renderAll();
        setActiveNav("cutover");
      });

      $("#approveBtn").addEventListener("click", ()=> doDecision("Approve"));
      $("#changesBtn").addEventListener("click", ()=> doDecision("Changes"));
      $("#rejectBtn").addEventListener("click", ()=> doDecision("Reject"));

      $("#aiItBtn").addEventListener("click", aiScan);
      $("#exportItBtn").addEventListener("click", exportItPack);

      $("#auditSearch").addEventListener("input", renderAudit);

      $("#resetBtn").addEventListener("click", ()=>{
        if(!confirm("Reset shared workspace data (localStorage)?")) return;
        localStorage.removeItem(Store.KEY);
        localStorage.removeItem(Store.SELECTED);
        location.reload();
      });

      wireModalClose("#aiModal");

      setActiveNav("inbox");
      renderAll();
    }

    wire();

    // Page switcher
    document.getElementById("pageSwitcher").addEventListener("change", (e)=>{
      window.location.href = e.target.value;
    });
  </script>
</body>
</html>
